#! /bin/sh

prefix=$1;  export prefix;  shift
command=$1; export command; shift
sender=$1;  export sender;  shift
forum=$1;   export forum;   shift
text=$1;    export text;    shift
# $* is now args

# Debug output
echo '>>>' ${prefix:+:}$prefix $command "$@" ${text:+:}"$text" 1>&2

raw () {
    fmt="\007$1\n"; shift
    printf "$fmt" "$@"
}

join () {
    raw "JOIN $1"
}

out=$(tempfile)

case $command in
    001)
        for chan in ${CHANNELS:-#cobalt}; do
            join $chan
        done
        ;;
    433)
        raw "NICK bottimus"
        ;;
    PRIVMSG)
        case "$forum" in
            \#*)
                ./firebot "$text" || \
                    ./whuffie woozle/whuffie.cdb "$text" || \
                    ./infobot woozle/factoids.cdb "$text"
                ./notes woozle/notes "$text"
                ;;
        esac
        ;;
    INVITE)
        join "$forum"
        raw "PRIVMSG %s :Thanks for the invitation, %s." "$forum" "$sender"
        ;;
esac  > $out

if [ "$forum" != "$sender" ] && [ $(wc -l < $out) -gt 5 ]; then
    printf "PRIVMSG %s :Too many lines, sending privately.\r\n" "$forum"
    forum=$sender
fi

while read -r line; do
    case "$line" in
        *)
            printf "%s\r\n" "${line#}"
            ;;
        *)
            printf "PRIVMSG %s :%s\r\n" "$forum" "$line"
            ;;
    esac
done < $out

rm -f $out

